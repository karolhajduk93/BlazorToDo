@using BlazorToDoApp.Models
@inject AppState AppState
@inject ISyncLocalStorageService localStorage

<div class=" container">
    <div class="upper-section">
        <h2 class="upper-section-title">
            My Day <br />
            <div class="title-date">@DateTime.Now.ToString("dddd, MMMM yyyy")</div>
        </h2>
        <div class="login-save-group">
            <button title="Save this list" class="@_saveButton"></button>
            <button title="Login" class="login-button"></button>
        </div>
    </div>
    <div class="add_task_block">
        <button title="Add a task" class="add" @onclick="AddTodo"> +</button>
        <input class="input" maxlength="255" placeholder="Add a task" @bind="_todoItemText" @onkeyup="KeyboardEventHandler" />
    </div>

    <div class="list">
       
        @foreach (var item in _itemsToDo.Where(item => !item.Checked))
        {
            <TodoItem @key="@item.Id" Model="@item" UpdateHappened="RerenderForUpdate"></TodoItem>
        }
        
        @if (_itemsDone.Any())
        {
            <div class="completed">
                <button class="dropdown-completed" id="dropdown-button" @onclick="HideShowCompletedTasks">
                    <div class=@_dropdownCompletedSign></div>
                </button>
                <label for="dropdown-button">Completed</label>
                <span class="number">@_itemsDone.Count</span>
            </div>
        }
        <div class="@_completedContainer">
            @foreach (var item in _itemsDone)
            {
                <TodoItem @key="@item.Id" Model="@item" UpdateHappened="RerenderForUpdate"></TodoItem>
            }
        </div>

    </div>
</div>



@code {

    private List<TodoItemModel> _itemsToDo;
    private List<TodoItemModel> _itemsDone;
    private string _todoItemText = string.Empty;
    private bool _completedVisible = true;
    private string _dropdownCompletedSign = "dropdown-sign-visible";
    private string _completedContainer = "completed-container-show";
    private string _saveButton = "save-button-hidden";


    private void RerenderForUpdate(Tuple<TodoItemModel, string> update)
    {
        switch (update.Item2)
        {
            case "remove":
                _itemsToDo.Remove(update.Item1);
                _itemsDone.Remove(update.Item1);
                break;
            case "toggle" when update.Item1.Checked:
                _itemsToDo.Remove(update.Item1);
                _itemsDone.Add(update.Item1);
                break;
            case "toggle":
                _itemsToDo.Add(update.Item1);
                _itemsDone.Remove(update.Item1);
                break;
        }

        UpdateLocalStorage("itemsToDo", _itemsToDo);
        UpdateLocalStorage("itemsDone", _itemsDone);

        StateHasChanged();
    }

    private void AddTodo()
    {
        if (_todoItemText == string.Empty) return;

        _itemsToDo.Add(new TodoItemModel(_todoItemText));
        UpdateLocalStorage("itemsToDo", _itemsToDo);
        _todoItemText = string.Empty;
    }

    private void KeyboardEventHandler(KeyboardEventArgs args)
    {
        if (args.Key == "Enter")
            AddTodo();
    }

    private void EnableSaveList()
    {
        _saveButton = "save-button-hidden";
    }

    private void HideShowCompletedTasks()
    {
        _completedVisible = !_completedVisible;
        _dropdownCompletedSign = _completedVisible ? "dropdown-sign-visible" : "dropdown-sign-hidden";
        _completedContainer = _completedVisible ? "completed-container-show" : "completed-container-hide";
    }

    public void UpdateLocalStorage(string key, List<TodoItemModel> list)
    {
        localStorage.SetItem(key, list);
    }

    protected override void OnInitialized()
    {
        _itemsToDo = localStorage.GetItem<List<TodoItemModel>>("itemsToDo") ?? new List<TodoItemModel>();
        _itemsDone = localStorage.GetItem<List<TodoItemModel>>("itemsDone") ?? new List<TodoItemModel>();

        StateHasChanged();
    }

}


